<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Interactivo con QR</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .live-indicator {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB1-qX4gDXs-WeSBaJu6Xhrvy8fVQ7vaes",
            authDomain: "medicia-65cee.firebaseapp.com",
            databaseURL: "https://medicia-65cee-default-rtdb.firebaseio.com",
            projectId: "medicia-65cee",
            storageBucket: "medicia-65cee.firebasestorage.app",
            messagingSenderId: "640591572141",
            appId: "1:640591572141:web:19d0f3d5935c05ebbf6a24",
            measurementId: "G-M5DZ6L0WL3"
        };

        let database = null;
        let auth = null;
        let activeListeners = [];

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            console.log('‚úÖ Firebase inicializado correctamente');
        } catch (error) {
            console.error('‚ùå Error inicializando Firebase:', error);
        }

        // Estado global
        let state = {
            view: 'login',
            user: null,
            quizzes: [],
            currentQuiz: null,
            editingQuiz: null,
            responses: {},
            participantName: '',
            currentAnswers: {},
            qrCode: '',
            sessionId: null,
            loginEmail: '',
            loginPassword: '',
            participantCount: 0
        };

        const COLORS = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];

        function setState(updates, skipRender = false) {
            state = { ...state, ...updates };
            if (!skipRender) render();
        }

        function updateState(updates) {
            state = { ...state, ...updates };
        }

        // ============================================
        // FUNCIONES DE AUTENTICACI√ìN
        // ============================================

        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                setState({ user: result.user, view: 'admin' });
                loadUserQuizzes(result.user.uid);
            } catch (error) {
                if (error.code === 'auth/popup-closed-by-user') return;
                alert('‚ùå Error al iniciar sesi√≥n: ' + error.message);
            }
        }

        async function loginUser() {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(state.loginEmail, state.loginPassword);
                setState({ user: userCredential.user, view: 'admin', loginEmail: '', loginPassword: '' });
                loadUserQuizzes(userCredential.user.uid);
            } catch (error) {
                alert('‚ùå ' + (error.code === 'auth/wrong-password' ? 'Contrase√±a incorrecta' : 'Error al iniciar sesi√≥n'));
            }
        }

        function logoutUser() {
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
            auth.signOut();
            setState({ user: null, view: 'login', quizzes: [], currentQuiz: null });
        }

        auth.onAuthStateChanged((user) => {
            if (user && state.view === 'login') {
                setState({ user: user, view: 'admin' });
                loadUserQuizzes(user.uid);
            }
        });

        // ============================================
        // FUNCIONES DE FIREBASE
        // ============================================

        function loadUserQuizzes(userId) {
            const quizzesRef = database.ref('quizzes/' + userId);
            const unsubscribe = quizzesRef.on('value', (snapshot) => {
                const quizzesData = snapshot.val();
                const quizzesList = quizzesData ? Object.keys(quizzesData).map(key => ({
                    ...quizzesData[key],
                    id: key
                })) : [];
                setState({ quizzes: quizzesList }, true);
                if (state.view === 'admin') render();
            });
            activeListeners.push(() => quizzesRef.off('value'));
        }

        function saveQuizToFirebase(quiz) {
            const userId = state.user.uid;
            const quizRef = database.ref('quizzes/' + userId + '/' + quiz.id);
            return quizRef.set({
                title: quiz.title,
                questions: quiz.questions,
                createdAt: quiz.createdAt,
                updatedAt: new Date().toISOString()
            });
        }

        function deleteQuizFromFirebase(quizId) {
            const userId = state.user.uid;
            return database.ref('quizzes/' + userId + '/' + quizId).remove();
        }

        function saveResponse(sessionId, participantData) {
            const responseRef = database.ref('responses/' + sessionId).push();
            return responseRef.set(participantData);
        }

        function loadResponses(sessionId, callback) {
            const responsesRef = database.ref('responses/' + sessionId);
            const unsubscribe = responsesRef.on('value', (snapshot) => {
                const responsesData = snapshot.val();
                const responsesList = responsesData ? Object.keys(responsesData).map(key => ({
                    ...responsesData[key],
                    id: key
                })) : [];
                callback(responsesList);
            });
            activeListeners.push(() => responsesRef.off('value'));
            return unsubscribe;
        }

        async function clearResponses(sessionId) {
            if (!confirm('¬øEst√°s seguro de borrar TODAS las respuestas?\n\nEsta acci√≥n no se puede deshacer.')) {
                return;
            }
            try {
                await database.ref('responses/' + sessionId).remove();
                alert('‚úÖ Respuestas borradas exitosamente');
                setState({ responses: {}, participantCount: 0 });
            } catch (error) {
                alert('‚ùå Error al borrar respuestas: ' + error.message);
            }
        }

        // ============================================
        // FUNCIONES DE CUESTIONARIOS
        // ============================================

        function addQuestion() {
            const quiz = state.editingQuiz;
            if (quiz.questions.length >= 10) {
                alert('M√°ximo 10 preguntas permitidas');
                return;
            }
            quiz.questions.push({
                question: '',
                options: ['', '', '', ''],
                correctAnswer: 0,
                hasCorrectAnswer: false  // Por defecto sin respuesta correcta (modo encuesta)
            });
            setState({ editingQuiz: quiz });
        }

        function updateQuestion(index, field, value) {
            const quiz = state.editingQuiz;
            quiz.questions[index][field] = value;
            updateState({ editingQuiz: quiz });
        }

        function updateOption(qIndex, oIndex, value) {
            const quiz = state.editingQuiz;
            quiz.questions[qIndex].options[oIndex] = value;
            updateState({ editingQuiz: quiz });
        }

        function toggleCorrectAnswer(qIndex) {
            const quiz = state.editingQuiz;
            quiz.questions[qIndex].hasCorrectAnswer = !quiz.questions[qIndex].hasCorrectAnswer;
            if (!quiz.questions[qIndex].hasCorrectAnswer) {
                quiz.questions[qIndex].correctAnswer = null;
            } else if (quiz.questions[qIndex].correctAnswer === null) {
                quiz.questions[qIndex].correctAnswer = 0;
            }
            setState({ editingQuiz: quiz });
        }

        function deleteQuestion(index) {
            const quiz = state.editingQuiz;
            quiz.questions.splice(index, 1);
            setState({ editingQuiz: quiz });
        }

        async function saveQuiz() {
            const quiz = state.editingQuiz;
            if (!quiz.title || quiz.questions.length === 0) {
                alert('Debes agregar un t√≠tulo y al menos una pregunta');
                return;
            }

            if (!state.user || !state.user.uid) {
                alert('‚ùå Error: No est√°s autenticado.');
                return;
            }

            if (!quiz.id) {
                quiz.id = 'quiz_' + Date.now();
                quiz.createdAt = new Date().toISOString();
            }

            try {
                await saveQuizToFirebase(quiz);
                alert('‚úÖ Cuestionario guardado exitosamente');
                setState({ editingQuiz: null, view: 'admin' });
            } catch (error) {
                console.error('Error guardando quiz:', error);
                alert('‚ùå Error al guardar: ' + error.message);
            }
        }

        function newQuiz() {
            setState({ 
                editingQuiz: { id: null, title: '', questions: [], createdAt: null },
                view: 'edit'
            });
        }

        function editQuiz(quiz) {
            setState({ 
                editingQuiz: JSON.parse(JSON.stringify(quiz)),
                view: 'edit'
            });
        }

        async function deleteQuiz(quizId) {
            if (!confirm('¬øEst√°s seguro de eliminar este cuestionario?')) return;
            try {
                await deleteQuizFromFirebase(quizId);
                alert('‚úÖ Cuestionario eliminado');
            } catch (error) {
                alert('‚ùå Error al eliminar: ' + error.message);
            }
        }

        function generateQRCode(quiz, sessionId) {
            const quizData = { quiz, sessionId };
            const encoded = btoa(encodeURIComponent(JSON.stringify(quizData)));
            const url = window.location.origin + window.location.pathname + '?q=' + encoded;
            return 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(url);
        }

        function activateQuiz(quiz) {
            const sessionId = 'session_' + Date.now();
            const qr = generateQRCode(quiz, sessionId);
            
            setState({ 
                currentQuiz: quiz,
                sessionId: sessionId,
                qrCode: qr,
                responses: {},
                participantCount: 0,
                view: 'dashboard'
            });

            loadResponses(sessionId, (responsesList) => {
                const responsesObj = {};
                responsesList.forEach(r => {
                    responsesObj[r.id] = r;
                });
                
                // Actualizar estado con contador correcto
                const newCount = responsesList.length;
                console.log('Participantes actuales:', newCount);
                
                // Actualizar estado sin skipRender para que se vea
                state.responses = responsesObj;
                state.participantCount = newCount;
                
                if (state.view === 'dashboard') {
                    render();
                }
            });
        }

        function copyQuizLink() {
            const quizData = { quiz: state.currentQuiz, sessionId: state.sessionId };
            const encoded = btoa(encodeURIComponent(JSON.stringify(quizData)));
            const url = window.location.origin + window.location.pathname + '?q=' + encoded;
            
            navigator.clipboard.writeText(url).then(() => {
                alert('‚úÖ Link copiado al portapapeles!');
            }).catch(() => {
                prompt('Copia este link:', url);
            });
        }

        // ============================================
        // FUNCIONES DE PARTICIPANTES
        // ============================================

        async function submitAnswers() {
            if (!state.participantName.trim()) {
                alert('Por favor ingresa tu nombre');
                return;
            }

            const answered = Object.keys(state.currentAnswers).length;
            if (answered < state.currentQuiz.questions.length) {
                alert('Por favor responde todas las preguntas (' + answered + '/' + state.currentQuiz.questions.length + ')');
                return;
            }

            try {
                await saveResponse(state.sessionId, {
                    name: state.participantName,
                    answers: state.currentAnswers,
                    timestamp: new Date().toISOString()
                });
                
                alert('‚úÖ ¬°Respuestas enviadas exitosamente!');
                setState({ view: 'thankyou', currentAnswers: {}, participantName: '' });
            } catch (error) {
                alert('‚ùå Error al enviar respuestas: ' + error.message);
            }
        }

        // ============================================
        // FUNCIONES DE EXPORTACI√ìN
        // ============================================

        function downloadResponsesCSV() {
            if (Object.keys(state.responses).length === 0) {
                alert('‚ö†Ô∏è No hay respuestas para exportar');
                return;
            }

            let csv = 'Participante,Timestamp';
            state.currentQuiz.questions.forEach((q, i) => {
                csv += ',Pregunta ' + (i + 1);
            });
            
            // Solo agregar columnas de correctas si al menos una pregunta las tiene
            const hasAnyCorrectAnswer = state.currentQuiz.questions.some(q => q.hasCorrectAnswer);
            if (hasAnyCorrectAnswer) {
                csv += ',Correctas,Precisi√≥n';
            }
            csv += '\n';

            Object.values(state.responses).forEach(response => {
                let row = '"' + response.name + '",';
                row += new Date(response.timestamp).toLocaleString() + ',';
                
                let correctCount = 0;
                state.currentQuiz.questions.forEach((q, i) => {
                    const answer = response.answers[i];
                    const optionText = answer !== undefined ? q.options[answer] : 'Sin respuesta';
                    row += '"' + optionText + '",';
                    if (q.hasCorrectAnswer && answer === q.correctAnswer) correctCount++;
                });
                
                if (hasAnyCorrectAnswer) {
                    const totalWithCorrect = state.currentQuiz.questions.filter(q => q.hasCorrectAnswer).length;
                    const accuracy = totalWithCorrect > 0 ? ((correctCount / totalWithCorrect) * 100).toFixed(1) : 0;
                    row += correctCount + ',' + accuracy + '%';
                }
                row += '\n';
                
                csv += row;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'respuestas_' + state.currentQuiz.title.replace(/[^a-z0-9]/gi, '_') + '.csv');
            link.click();
            URL.revokeObjectURL(url);
        }

        function downloadResponsesJSON() {
            if (Object.keys(state.responses).length === 0) {
                alert('‚ö†Ô∏è No hay respuestas para exportar');
                return;
            }

            const exportData = {
                quiz: state.currentQuiz,
                responses: state.responses,
                exportDate: new Date().toISOString(),
                participantCount: Object.keys(state.responses).length
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'respuestas_' + state.currentQuiz.title.replace(/[^a-z0-9]/gi, '_') + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // ============================================
        // RENDERIZADO DE VISTAS
        // ============================================

        function renderLogin() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-4 flex items-center justify-center">
                    <div class="max-w-md w-full">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üì±</div>
                            <h1 class="text-4xl font-bold text-gray-800 mb-2">Quiz Interactivo</h1>
                            <p class="text-gray-600">Sistema de cuestionarios con c√≥digo QR</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-8 mb-4">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Iniciar Sesi√≥n</h2>
                            
                            <button
                                onclick="loginWithGoogle()"
                                class="w-full flex items-center justify-center gap-3 px-6 py-4 bg-white border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 hover:border-gray-400 font-semibold mb-6 transition-all shadow-sm"
                            >
                                <svg width="20" height="20" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                Continuar con Google
                            </button>

                            <div class="relative mb-6">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-4 bg-white text-gray-500">O ingresa con email</span>
                                </div>
                            </div>

                            <input
                                type="email"
                                id="login-email"
                                placeholder="Email"
                                value="${state.loginEmail}"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-indigo-500 focus:outline-none"
                            />

                            <input
                                type="password"
                                id="login-password"
                                placeholder="Contrase√±a"
                                value="${state.loginPassword}"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg mb-6 focus:border-indigo-500 focus:outline-none"
                            />

                            <button
                                onclick="loginUser()"
                                class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold"
                            >
                                üîê Iniciar con Email
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdmin() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-6">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">üì± Quiz Interactivo</h1>
                                    <p class="text-gray-600">Panel de administraci√≥n</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-600 mb-2">üë§ ${state.user.displayName || state.user.email}</p>
                                    <button onclick="logoutUser()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">
                                        üö™ Cerrar Sesi√≥n
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">Mis Cuestionarios</h2>
                                <button onclick="newQuiz()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold flex items-center gap-2">
                                    <span class="text-xl">+</span> Nuevo Cuestionario
                                </button>
                            </div>

                            ${state.quizzes.length === 0 ? `
                                <div class="text-center py-12">
                                    <div class="text-6xl mb-4">üìù</div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">No tienes cuestionarios a√∫n</h3>
                                    <p class="text-gray-600 mb-6">Crea tu primer cuestionario para comenzar</p>
                                    <button onclick="newQuiz()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">
                                        Crear mi primer Quiz
                                    </button>
                                </div>
                            ` : `
                                <div class="grid md:grid-cols-2 gap-4">
                                    ${state.quizzes.map(quiz => `
                                        <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-indigo-400 transition-colors">
                                            <h3 class="text-xl font-bold text-gray-800 mb-2">${quiz.title}</h3>
                                            <p class="text-gray-600 mb-4">${quiz.questions.length} preguntas</p>
                                            <div class="flex gap-2">
                                                <button onclick='activateQuiz(${JSON.stringify(quiz).replace(/'/g, "&#39;")})' class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold text-sm">
                                                    ‚ñ∂Ô∏è Activar
                                                </button>
                                                <button onclick='editQuiz(${JSON.stringify(quiz).replace(/'/g, "&#39;")})' class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm">
                                                    ‚úèÔ∏è Editar
                                                </button>
                                                <button onclick="deleteQuiz('${quiz.id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEdit() {
            const quiz = state.editingQuiz;
            return `
                <div class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 p-4 sm:p-6">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-6">
                            <div class="flex justify-between items-center mb-6">
                                <h1 class="text-3xl font-bold text-gray-800">${quiz.id ? 'Editar' : 'Crear'} Cuestionario</h1>
                                <button onclick="setState({ view: 'admin', editingQuiz: null })" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold">
                                    ‚Üê Volver
                                </button>
                            </div>

                            <input
                                type="text"
                                id="quiz-title"
                                placeholder="T√≠tulo del cuestionario"
                                value="${quiz.title}"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg mb-6 text-lg focus:border-purple-500 focus:outline-none"
                            />

                            <div id="questions-container" class="space-y-4 mb-6">
                                ${quiz.questions.map((q, qIndex) => `
                                    <div class="bg-gray-50 p-6 rounded-xl border-2 border-gray-200">
                                        <div class="flex justify-between items-start mb-4">
                                            <span class="text-lg font-semibold text-gray-700">Pregunta ${qIndex + 1}</span>
                                            <button onclick="deleteQuestion(${qIndex})" class="text-red-500 hover:text-red-700 text-2xl">√ó</button>
                                        </div>
                                        
                                        <input
                                            type="text"
                                            value="${q.question}"
                                            oninput="updateQuestion(${qIndex}, 'question', this.value)"
                                            placeholder="Escribe la pregunta"
                                            class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-purple-500 focus:outline-none"
                                        />

                                        <div class="space-y-3 mb-4">
                                            ${q.options.map((option, oIndex) => `
                                                <div class="flex items-center gap-3">
                                                    ${q.hasCorrectAnswer ? `
                                                        <input
                                                            type="radio"
                                                            name="correct-${qIndex}"
                                                            ${q.correctAnswer === oIndex ? 'checked' : ''}
                                                            onclick="updateQuestion(${qIndex}, 'correctAnswer', ${oIndex}); render();"
                                                            class="w-5 h-5"
                                                        />
                                                    ` : `
                                                        <div class="w-5 h-5"></div>
                                                    `}
                                                    <input
                                                        type="text"
                                                        value="${option}"
                                                        oninput="updateOption(${qIndex}, ${oIndex}, this.value)"
                                                        placeholder="Opci√≥n ${oIndex + 1}"
                                                        class="flex-1 p-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                                    />
                                                </div>
                                            `).join('')}
                                        </div>

                                        <div class="flex items-center gap-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                            <input
                                                type="checkbox"
                                                id="has-correct-${qIndex}"
                                                ${q.hasCorrectAnswer ? 'checked' : ''}
                                                onchange="toggleCorrectAnswer(${qIndex})"
                                                class="w-5 h-5"
                                            />
                                            <label for="has-correct-${qIndex}" class="text-sm font-semibold text-gray-700 cursor-pointer">
                                                ${q.hasCorrectAnswer ? '‚úÖ Esta pregunta tiene respuesta correcta' : 'üìä Modo encuesta (sin respuesta correcta)'}
                                            </label>
                                        </div>
                                        
                                        ${q.hasCorrectAnswer ? '<p class="text-xs text-gray-500 mt-2">Selecciona con el c√≠rculo cu√°l es la respuesta correcta</p>' : '<p class="text-xs text-gray-500 mt-2">En modo encuesta no hay respuestas correctas o incorrectas</p>'}
                                    </div>
                                `).join('')}
                            </div>

                            <div class="flex flex-col sm:flex-row gap-4">
                                <button
                                    onclick="addQuestion()"
                                    ${quiz.questions.length >= 10 ? 'disabled' : ''}
                                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold ${quiz.questions.length >= 10 ? 'opacity-50 cursor-not-allowed' : ''}"
                                >
                                    ‚ûï Agregar Pregunta (${quiz.questions.length}/10)
                                </button>
                                
                                <button
                                    onclick="saveQuiz()"
                                    class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
                                >
                                    ‚úÖ Guardar Cuestionario
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const responseCount = state.participantCount;
            const totalQuestions = state.currentQuiz.questions.length;
            const totalPossibleResponses = responseCount * totalQuestions;
            
            // Calcular respuestas por pregunta
            const responsesPerQuestion = {};
            state.currentQuiz.questions.forEach((q, index) => {
                responsesPerQuestion[index] = 0;
            });
            
            Object.values(state.responses).forEach(response => {
                Object.keys(response.answers).forEach(qIndex => {
                    responsesPerQuestion[qIndex]++;
                });
            });

            return `
                <div class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 p-4 sm:p-6">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-6">
                            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800 mb-2">${state.currentQuiz.title}</h1>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 bg-green-500 rounded-full live-indicator"></div>
                                            <span class="text-sm font-semibold text-green-600">EN VIVO</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2 flex-wrap">
                                    <button onclick="downloadResponsesCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm">
                                        üìä CSV
                                    </button>
                                    <button onclick="downloadResponsesJSON()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm">
                                        üíæ JSON
                                    </button>
                                    <button onclick="clearResponses('${state.sessionId}')" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold text-sm">
                                        üóëÔ∏è Borrar
                                    </button>
                                    <button onclick="setState({ view: 'admin' })" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold text-sm">
                                        ‚Üê Volver
                                    </button>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 mb-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">üì± Comparte con tus participantes</h2>
                                <div class="flex justify-center mb-4">
                                    <img src="${state.qrCode}" alt="QR Code" class="rounded-lg shadow-lg">
                                </div>
                                <div class="text-center">
                                    <button onclick="copyQuizLink()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">
                                        üîó Copiar Link
                                    </button>
                                </div>
                            </div>
                        </div>

                        ${responseCount === 0 ? `
                            <div class="bg-white rounded-2xl shadow-xl p-12 text-center">
                                <div class="text-6xl mb-4">‚è≥</div>
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">Esperando participantes...</h3>
                                <p class="text-gray-600">Comparte el c√≥digo QR o el link para que comiencen a responder</p>
                                <p class="text-sm text-green-600 mt-4">üîÑ Los resultados se actualizan autom√°ticamente</p>
                            </div>
                        ` : `
                            <!-- Contadores principales -->
                            <div class="grid md:grid-cols-3 gap-6 mb-6">
                                <div class="bg-white rounded-2xl shadow-xl p-8 text-center border-4 border-blue-200">
                                    <div class="text-5xl font-bold text-blue-600 mb-2">${responseCount}</div>
                                    <div class="text-gray-700 font-semibold">üë• Participantes</div>
                                </div>
                                
                                <div class="bg-white rounded-2xl shadow-xl p-8 text-center border-4 border-purple-200">
                                    <div class="text-5xl font-bold text-purple-600 mb-2">${totalQuestions}</div>
                                    <div class="text-gray-700 font-semibold">üìù Preguntas</div>
                                </div>
                                
                                <div class="bg-white rounded-2xl shadow-xl p-8 text-center border-4 border-green-200">
                                    <div class="text-5xl font-bold text-green-600 mb-2">${totalPossibleResponses > 0 ? ((Object.keys(state.responses).length * totalQuestions / totalPossibleResponses * 100).toFixed(0)) : 0}%</div>
                                    <div class="text-gray-700 font-semibold">‚úÖ Completitud</div>
                                </div>
                            </div>

                            <!-- Gr√°fico circular general -->
                            <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üìä Distribuci√≥n General de Respuestas</h2>
                                <div class="max-w-md mx-auto" style="height: 400px;">
                                    <canvas id="general-chart"></canvas>
                                </div>
                            </div>

                            <!-- Tabla de respuestas por pregunta -->
                            <div class="bg-white rounded-2xl shadow-xl p-8">
                                <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã Detalle por Pregunta</h2>
                                <div class="space-y-4">
                                    ${state.currentQuiz.questions.map((q, index) => {
                                        const responses = responsesPerQuestion[index] || 0;
                                        const percentage = responseCount > 0 ? ((responses / responseCount) * 100).toFixed(0) : 0;
                                        
                                        // Calcular respuestas por opci√≥n
                                        const optionCounts = q.options.map(() => 0);
                                        Object.values(state.responses).forEach(response => {
                                            const answer = response.answers[index];
                                            if (answer !== undefined) {
                                                optionCounts[answer]++;
                                            }
                                        });
                                        
                                        const maxCount = Math.max(...optionCounts);
                                        
                                        return `
                                            <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-indigo-300 transition-colors">
                                                <div class="flex justify-between items-start mb-4">
                                                    <h3 class="text-lg font-bold text-gray-800 flex-1">Pregunta ${index + 1}: ${q.question}</h3>
                                                    <div class="text-right ml-4">
                                                        <div class="text-2xl font-bold text-indigo-600">${responses}/${responseCount}</div>
                                                        <div class="text-sm text-gray-600">${percentage}% respondi√≥</div>
                                                    </div>
                                                </div>
                                                
                                                <div class="space-y-2">
                                                    ${q.options.map((option, oIndex) => {
                                                        const count = optionCounts[oIndex];
                                                        const optPercentage = responses > 0 ? ((count / responses) * 100).toFixed(0) : 0;
                                                        const isCorrect = q.hasCorrectAnswer && q.correctAnswer === oIndex;
                                                        const isMostChosen = count === maxCount && count > 0;
                                                        
                                                        return `
                                                            <div class="flex items-center gap-3">
                                                                <div class="flex-1">
                                                                    <div class="flex items-center justify-between mb-1">
                                                                        <span class="text-sm font-medium text-gray-700">
                                                                            ${isCorrect ? '‚úÖ ' : ''}${option}
                                                                        </span>
                                                                        <span class="text-sm font-bold ${isMostChosen ? 'text-indigo-600' : 'text-gray-600'}">
                                                                            ${count} (${optPercentage}%)
                                                                        </span>
                                                                    </div>
                                                                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                                                        <div class="h-full rounded-full transition-all duration-500 ${isCorrect ? 'bg-green-500' : isMostChosen ? 'bg-indigo-500' : 'bg-gray-400'}" 
                                                                             style="width: ${optPercentage}%">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                </div>
                                                
                                                ${q.hasCorrectAnswer ? `
                                                    <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                                                        <span class="text-sm font-semibold text-green-800">
                                                            Respuesta correcta: ${q.options[q.correctAnswer]} 
                                                            (${optionCounts[q.correctAnswer]} personas, ${responses > 0 ? ((optionCounts[q.correctAnswer] / responses) * 100).toFixed(0) : 0}% de precisi√≥n)
                                                        </span>
                                                    </div>
                                                ` : `
                                                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                        <span class="text-sm font-semibold text-blue-800">
                                                            üìä Modo encuesta - No hay respuesta correcta
                                                        </span>
                                                    </div>
                                                `}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `}
                    </div>
                    
                    ${responseCount > 0 ? `
                        <script>
                            // Crear gr√°fico circular general
                            setTimeout(() => {
                                const canvas = document.getElementById('general-chart');
                                if (canvas) {
                                    const existingChart = Chart.getChart(canvas);
                                    if (existingChart) existingChart.destroy();
                                    
                                    const ctx = canvas.getContext('2d');
                                    
                                    // Datos para el gr√°fico: respuestas por pregunta
                                    const labels = [];
                                    const data = [];
                                    const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#14b8a6'];
                                    
                                    ${state.currentQuiz.questions.map((q, index) => `
                                        labels.push('P${index + 1}: ${q.question.substring(0, 30)}...');
                                        data.push(${responsesPerQuestion[index] || 0});
                                    `).join('')}
                                    
                                    new Chart(ctx, {
                                        type: 'pie',
                                        data: {
                                            labels: labels,
                                            datasets: [{
                                                data: data,
                                                backgroundColor: colors,
                                                borderWidth: 3,
                                                borderColor: '#ffffff'
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            plugins: {
                                                legend: {
                                                    position: 'bottom',
                                                    labels: {
                                                        padding: 15,
                                                        font: { size: 13 },
                                                        color: '#374151'
                                                    }
                                                },
                                                tooltip: {
                                                    callbacks: {
                                                        label: (context) => {
                                                            const value = context.parsed;
                                                            const total = data.reduce((a, b) => a + b, 0);
                                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                                            return context.label + ': ' + value + ' respuestas (' + percentage + '%)';
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    });
                                }
                            }, 200);
                        </script>
                    ` : ''}
                </div>
            `;
        }

        function selectAnswer(qIndex, oIndex) {
            updateState({ currentAnswers: { ...state.currentAnswers, [qIndex]: oIndex } });
            render();
        }

        function renderParticipant() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 p-4 sm:p-6">
                    <div class="max-w-3xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">${state.currentQuiz.title}</h1>
                            <p class="text-gray-600 mb-6">Responde todas las preguntas y env√≠a tus respuestas</p>

                            <input
                                type="text"
                                id="participant-name"
                                placeholder="Tu nombre"
                                value="${state.participantName}"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg mb-6 text-lg focus:border-green-500 focus:outline-none"
                            />

                            <div class="space-y-6 mb-6">
                                ${state.currentQuiz.questions.map((q, qIndex) => `
                                    <div class="bg-gray-50 p-6 rounded-xl border-2 border-gray-200">
                                        <h3 class="text-lg font-bold text-gray-800 mb-4">${qIndex + 1}. ${q.question}</h3>
                                        <div class="space-y-3">
                                            ${q.options.map((option, oIndex) => `
                                                <label class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${state.currentAnswers[qIndex] === oIndex ? 'bg-green-100 border-2 border-green-500' : 'bg-white border-2 border-gray-300 hover:border-green-300'}">
                                                    <input
                                                        type="radio"
                                                        name="question-${qIndex}"
                                                        ${state.currentAnswers[qIndex] === oIndex ? 'checked' : ''}
                                                        onclick="selectAnswer(${qIndex}, ${oIndex})"
                                                        class="w-5 h-5"
                                                    />
                                                    <span class="text-gray-800">${option}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <button
                                onclick="submitAnswers()"
                                class="w-full px-6 py-4 bg-green-600 text-white rounded-xl hover:bg-green-700 font-bold text-lg"
                            >
                                ‚úÖ Enviar Respuestas
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderThankYou() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 p-4 flex items-center justify-center">
                    <div class="max-w-md mx-auto text-center">
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <div class="text-6xl mb-4">‚úÖ</div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-4">¬°Gracias por participar!</h1>
                            <p class="text-gray-600 mb-6">Tus respuestas han sido enviadas correctamente</p>
                            <p class="text-sm text-gray-500">El presentador puede ver tus respuestas en tiempo real</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // RENDER PRINCIPAL
        // ============================================

        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'login') {
                app.innerHTML = renderLogin();
                const emailInput = document.getElementById('login-email');
                const passwordInput = document.getElementById('login-password');
                if (emailInput) {
                    emailInput.addEventListener('input', (e) => updateState({ loginEmail: e.target.value }));
                    emailInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') loginUser(); });
                }
                if (passwordInput) {
                    passwordInput.addEventListener('input', (e) => updateState({ loginPassword: e.target.value }));
                    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') loginUser(); });
                }
            } else if (state.view === 'admin') {
                app.innerHTML = renderAdmin();
            } else if (state.view === 'edit') {
                app.innerHTML = renderEdit();
                const titleInput = document.getElementById('quiz-title');
                if (titleInput) {
                    titleInput.addEventListener('input', (e) => {
                        const quiz = state.editingQuiz;
                        quiz.title = e.target.value;
                        updateState({ editingQuiz: quiz });
                    });
                }
            } else if (state.view === 'dashboard') {
                app.innerHTML = renderDashboard();
                updateDashboardCharts();
            } else if (state.view === 'participant') {
                app.innerHTML = renderParticipant();
                const nameInput = document.getElementById('participant-name');
                if (nameInput) {
                    nameInput.addEventListener('input', (e) => updateState({ participantName: e.target.value }));
                }
            } else if (state.view === 'thankyou') {
                app.innerHTML = renderThankYou();
            }
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const encodedQuiz = params.get('q');
            
            if (encodedQuiz) {
                try {
                    const quizData = JSON.parse(decodeURIComponent(atob(encodedQuiz)));
                    const qr = generateQRCode(quizData.quiz, quizData.sessionId);
                    
                    setState({ 
                        currentQuiz: quizData.quiz,
                        sessionId: quizData.sessionId,
                        qrCode: qr,
                        view: 'participant',
                        responses: {},
                        currentAnswers: {},
                        participantName: ''
                    });
                } catch (error) {
                    console.error('Error cargando quiz:', error);
                    render();
                }
            } else {
                render();
            }
        });
    </script>
</body>
</html>
