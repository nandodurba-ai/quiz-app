<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Interactivo con QR</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .live-indicator {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB1-qX4gDXs-WeSBaJu6Xhrvy8fVQ7vaes",
            authDomain: "medicia-65cee.firebaseapp.com",
            databaseURL: "https://medicia-65cee-default-rtdb.firebaseio.com",
            projectId: "medicia-65cee",
            storageBucket: "medicia-65cee.firebasestorage.app",
            messagingSenderId: "640591572141",
            appId: "1:640591572141:web:19d0f3d5935c05ebbf6a24",
            measurementId: "G-M5DZ6L0WL3"
        };

        let database = null;
        let auth = null;
        let activeListeners = [];

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            console.log('✅ Firebase inicializado correctamente');
        } catch (error) {
            console.error('❌ Error inicializando Firebase:', error);
        }

        // Estado global
        let state = {
            view: 'login',
            user: null,
            quizzes: [],
            currentQuiz: null,
            editingQuiz: null,
            responses: {},
            participantName: '',
            currentAnswers: {},
            qrCode: '',
            sessionId: null,
            loginEmail: '',
            loginPassword: '',
            participantCount: 0
        };

        const COLORS = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];

        function setState(updates, skipRender = false) {
            state = { ...state, ...updates };
            if (!skipRender) render();
        }

        function updateState(updates) {
            state = { ...state, ...updates };
        }

        // ============================================
        // FUNCIONES DE AUTENTICACIÓN
        // ============================================

        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                setState({ user: result.user, view: 'admin' });
                loadUserQuizzes(result.user.uid);
            } catch (error) {
                if (error.code === 'auth/popup-closed-by-user') return;
                alert('❌ Error al iniciar sesión: ' + error.message);
            }
        }

        async function loginUser() {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(state.loginEmail, state.loginPassword);
                setState({ user: userCredential.user, view: 'admin', loginEmail: '', loginPassword: '' });
                loadUserQuizzes(userCredential.user.uid);
            } catch (error) {
                alert('❌ ' + (error.code === 'auth/wrong-password' ? 'Contraseña incorrecta' : 'Error al iniciar sesión'));
            }
        }

        function logoutUser() {
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
            auth.signOut();
            setState({ user: null, view: 'login', quizzes: [], currentQuiz: null });
        }

        auth.onAuthStateChanged((user) => {
            if (user && state.view === 'login') {
                setState({ user: user, view: 'admin' });
                loadUserQuizzes(user.uid);
            }
        });

        // ============================================
        // FUNCIONES DE FIREBASE
        // ============================================

        function loadUserQuizzes(userId) {
            const quizzesRef = database.ref('quizzes/' + userId);
            const unsubscribe = quizzesRef.on('value', (snapshot) => {
                const quizzesData = snapshot.val();
                const quizzesList = quizzesData ? Object.keys(quizzesData).map(key => ({
                    ...quizzesData[key],
                    id: key
                })) : [];
                setState({ quizzes: quizzesList }, true);
                if (state.view === 'admin') render();
            });
            activeListeners.push(() => quizzesRef.off('value'));
        }

        function saveQuizToFirebase(quiz) {
            const userId = state.user.uid;
            const quizRef = database.ref('quizzes/' + userId + '/' + quiz.id);
            return quizRef.set({
                title: quiz.title,
                questions: quiz.questions,
                createdAt: quiz.createdAt,
                updatedAt: new Date().toISOString()
            });
        }

        function deleteQuizFromFirebase(quizId) {
            const userId = state.user.uid;
            return database.ref('quizzes/' + userId + '/' + quizId).remove();
        }

        function saveResponse(sessionId, participantData) {
            const responseRef = database.ref('responses/' + sessionId).push();
            return responseRef.set(participantData);
        }

        function loadResponses(sessionId, callback) {
            const responsesRef = database.ref('responses/' + sessionId);
            const unsubscribe = responsesRef.on('value', (snapshot) => {
                const responsesData = snapshot.val();
                const responsesList = responsesData ? Object.keys(responsesData).map(key => ({
                    ...responsesData[key],
                    id: key
                })) : [];
                callback(responsesList);
            });
            activeListeners.push(() => responsesRef.off('value'));
            return unsubscribe;
        }

        async function clearResponses(sessionId) {
            if (!confirm('¿Estás seguro de borrar TODAS las respuestas?\n\nEsta acción no se puede deshacer.')) {
                return;
            }
            try {
                await database.ref('responses/' + sessionId).remove();
                alert('✅ Respuestas borradas exitosamente');
                setState({ responses: {}, participantCount: 0 });
            } catch (error) {
                alert('❌ Error al borrar respuestas: ' + error.message);
            }
        }

        // ============================================
        // FUNCIONES DE CUESTIONARIOS
        // ============================================

        function addQuestion() {
            const quiz = state.editingQuiz;
            if (quiz.questions.length >= 10) {
                alert('Máximo 10 preguntas permitidas');
                return;
            }
            quiz.questions.push({
                question: '',
                options: ['', '', '', ''],
                correctAnswer: 0,
                hasCorrectAnswer: false  // Por defecto sin respuesta correcta (modo encuesta)
            });
            setState({ editingQuiz: quiz });
        }

        function updateQuestion(index, field, value) {
            const quiz = state.editingQuiz;
            quiz.questions[index][field] = value;
            updateState({ editingQuiz: quiz });
        }

        function updateOption(qIndex, oIndex, value) {
            const quiz = state.editingQuiz;
            quiz.questions[qIndex].options[oIndex] = value;
            updateState({ editingQuiz: quiz });
        }

        function toggleCorrectAnswer(qIndex) {
            const quiz = state.editingQuiz;
            quiz.questions[qIndex].hasCorrectAnswer = !quiz.questions[qIndex].hasCorrectAnswer;
            if (!quiz.questions[qIndex].hasCorrectAnswer) {
                quiz.questions[qIndex].correctAnswer = null;
            } else if (quiz.questions[qIndex].correctAnswer === null) {
                quiz.questions[qIndex].correctAnswer = 0;
            }
            setState({ editingQuiz: quiz });
        }

        function deleteQuestion(index) {
            const quiz = state.editingQuiz;
            quiz.questions.splice(index, 1);
            setState({ editingQuiz: quiz });
        }

        async function saveQuiz() {
            const quiz = state.editingQuiz;
            if (!quiz.title || quiz.questions.length === 0) {
                alert('Debes agregar un título y al menos una pregunta');
                return;
            }

            if (!state.user || !state.user.uid) {
                alert('❌ Error: No estás autenticado.');
                return;
            }

            if (!quiz.id) {
                quiz.id = 'quiz_' + Date.now();
                quiz.createdAt = new Date().toISOString();
            }

            try {
                await saveQuizToFirebase(quiz);
                alert('✅ Cuestionario guardado exitosamente');
                setState({ editingQuiz: null, view: 'admin' });
            } catch (error) {
                console.error('Error guardando quiz:', error);
                alert('❌ Error al guardar: ' + error.message);
            }
        }

        function newQuiz() {
            setState({ 
                editingQuiz: { id: null, title: '', questions: [], createdAt: null },
                view: 'edit'
            });
        }

        function editQuiz(quiz) {
            setState({ 
                editingQuiz: JSON.parse(JSON.stringify(quiz)),
                view: 'edit'
            });
        }

        async function deleteQuiz(quizId) {
            if (!confirm('¿Estás seguro de eliminar este cuestionario?')) return;
            try {
                await deleteQuizFromFirebase(quizId);
                alert('✅ Cuestionario eliminado');
            } catch (error) {
                alert('❌ Error al eliminar: ' + error.message);
            }
        }

        function generateQRCode(quiz, sessionId) {
            const quizData = { quiz, sessionId };
            const encoded = btoa(encodeURIComponent(JSON.stringify(quizData)));
            const url = window.location.origin + window.location.pathname + '?q=' + encoded;
            return 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(url);
        }

        function activateQuiz(quiz) {
            const sessionId = 'session_' + Date.now();
            const qr = generateQRCode(quiz, sessionId);
            
            setState({ 
                currentQuiz: quiz,
                sessionId: sessionId,
                qrCode: qr,
                responses: {},
                participantCount: 0,
                view: 'dashboard'
            });

            loadResponses(sessionId, (responsesList) => {
                const responsesObj = {};
                responsesList.forEach(r => {
                    responsesObj[r.id] = r;
                });
                
                // Actualizar estado con contador correcto
                const newCount = responsesList.length;
                console.log('Participantes actuales:', newCount);
                
                // Actualizar estado sin skipRender para que se vea
                st
