<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Interactivo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #4F46E5; color: white; }
        .btn-primary:hover { background: #4338CA; }
        .btn-success { background: #10B981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #EF4444; color: white; }
        .btn-danger:hover { background: #DC2626; }
        .input { width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 14px; margin-bottom: 16px; }
        .input:focus { outline: none; border-color: #4F46E5; }
        h1 { font-size: 28px; margin-bottom: 16px; color: #111827; }
        h2 { font-size: 20px; margin-bottom: 12px; color: #374151; }
        .quiz-item { border: 1px solid #E5E7EB; padding: 16px; border-radius: 8px; margin-bottom: 12px; }
        .option-label { display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
        .option-label:hover { border-color: #4F46E5; }
        .option-label.selected { background: #EEF2FF; border-color: #4F46E5; }
        .loading { text-align: center; padding: 40px; color: #6B7280; }
    </style>
</head>
<body>
    <div id="app"><div class="loading">Cargando...</div></div>
    <script>

        const firebaseConfig = {
            apiKey: "AIzaSyB1-qX4gDXs-WeSBaJu6Xhrvy8fVQ7vaes",
            authDomain: "medicia-65cee.firebaseapp.com",
            databaseURL: "https://medicia-65cee-default-rtdb.firebaseio.com",
            projectId: "medicia-65cee",
            storageBucket: "medicia-65cee.firebasestorage.app",
            messagingSenderId: "640591572141",
            appId: "1:640591572141:web:19d0f3d5935c05ebbf6a24",
            measurementId: "G-M5DZ6L0WL3"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        let state = {
            view: 'login',
            user: null,
            quizzes: [],
            currentQuiz: null,
            sessionId: null,
            participantName: '',
            currentAnswers: {},
            responses: {}
        };

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function render() {
            const app = document.getElementById('app');
            if (state.view === 'login') {
                renderLogin(app);
            } else if (state.view === 'admin') {
                renderAdmin(app);
            } else if (state.view === 'participant') {
                renderParticipant(app);
            } else if (state.view === 'thankyou') {
                renderThankYou(app);
            }
        }

        function renderLogin(app) {
            app.innerHTML = '<div class="container" style="max-width: 400px; margin-top: 100px;">' +
                '<div class="card">' +
                '<h1 style="text-align: center; margin-bottom: 24px;">Quiz Interactivo</h1>' +
                '<button class="btn btn-primary" style="width: 100%;" onclick="loginWithGoogle()">Continuar con Google</button>' +
                '</div></div>';
        }

        function renderAdmin(app) {
            let html = '<div class="container">' +
                '<div class="card">' +
                '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                '<h1>Mis Cuestionarios</h1>' +
                '<button class="btn btn-danger" onclick="logout()">Salir</button>' +
                '</div></div>' +
                '<div class="card">' +
                '<button class="btn btn-success" onclick="newQuiz()" style="margin-bottom: 20px;">+ Nuevo Quiz</button>';
            
            if (state.quizzes.length === 0) {
                html += '<p style="text-align: center; color: #6B7280; padding: 40px;">No tienes quizzes. Crea uno nuevo.</p>';
            } else {
                for (let i = 0; i < state.quizzes.length; i++) {
                    const quiz = state.quizzes[i];
                    html += '<div class="quiz-item">' +
                        '<h2>' + escapeHtml(quiz.title) + '</h2>' +
                        '<p style="color: #6B7280; margin-bottom: 12px;">' + quiz.questions.length + ' preguntas</p>' +
                        '<button class="btn btn-primary" onclick="activateQuiz('' + quiz.id + '')">Activar</button> ' +
                        '<button class="btn btn-danger" onclick="deleteQuiz('' + quiz.id + '')">Borrar</button>' +
                        '</div>';
                }
            }
            
            html += '</div></div>';
            app.innerHTML = html;
        }

        function renderParticipant(app) {
            let html = '<div class="container" style="max-width: 800px;">' +
                '<div class="card">' +
                '<h1>' + escapeHtml(state.currentQuiz.title) + '</h1>' +
                '<p style="color: #6B7280; margin-bottom: 20px;">Responde todas las preguntas</p>' +
                '<input type="text" id="participant-name" class="input" placeholder="Tu nombre" value="' + escapeHtml(state.participantName) + '">';
            
            for (let qIdx = 0; qIdx < state.currentQuiz.questions.length; qIdx++) {
                const q = state.currentQuiz.questions[qIdx];
                html += '<div style="margin-bottom: 24px; padding: 20px; background: #F9FAFB; border-radius: 8px;">' +
                    '<h2>' + (qIdx + 1) + '. ' + escapeHtml(q.question) + '</h2>';
                
                for (let oIdx = 0; oIdx < q.options.length; oIdx++) {
                    const opt = q.options[oIdx];
                    const selected = (state.currentAnswers[qIdx] === oIdx);
                    const className = selected ? 'option-label selected' : 'option-label';
                    html += '<label class="' + className + '">' +
                        '<input type="radio" name="q' + qIdx + '" ' + (selected ? 'checked' : '') + ' onclick="selectAnswer(' + qIdx + ',' + oIdx + ')">' +
                        '<span>' + escapeHtml(opt) + '</span>' +
                        '</label>';
                }
                
                html += '</div>';
            }
            
            html += '<button class="btn btn-success" style="width: 100%;" onclick="submitAnswers()">Enviar Respuestas</button>' +
                '</div></div>';
            
            app.innerHTML = html;
            
            const nameInput = document.getElementById('participant-name');
            if (nameInput) {
                nameInput.addEventListener('input', function(e) {
                    state.participantName = e.target.value;
                });
            }
        }

        function renderThankYou(app) {
            app.innerHTML = '<div class="container" style="max-width: 500px; margin-top: 100px;">' +
                '<div class="card" style="text-align: center;">' +
                '<div style="font-size: 64px; margin-bottom: 20px;">✅</div>' +
                '<h1>¡Gracias por participar!</h1>' +
                '<p style="color: #6B7280; margin-top: 12px;">Tus respuestas han sido enviadas</p>' +
                '</div></div>';
        }

        function selectAnswer(qIdx, oIdx) {
            state.currentAnswers[qIdx] = oIdx;
            render();
        }

        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                state.user = result.user;
                state.view = 'admin';
                loadQuizzes();
            } catch (error) {
                if (error.code !== 'auth/popup-closed-by-user') {
                    alert('Error: ' + error.message);
                }
            }
        }

        function logout() {
            auth.signOut();
            state.user = null;
            state.view = 'login';
            state.quizzes = [];
            render();
        }

        function loadQuizzes() {
            if (!state.user) return;
            database.ref('quizzes/' + state.user.uid).on('value', function(snapshot) {
                const data = snapshot.val();
                state.quizzes = [];
                if (data) {
                    for (let key in data) {
                        state.quizzes.push({
                            id: key,
                            title: data[key].title || 'Sin título',
                            questions: data[key].questions || []
                        });
                    }
                }
                if (state.view === 'admin') render();
            });
        }

        function newQuiz() {
            const title = prompt('Título del quiz:');
            if (!title) return;
            
            const quizId = 'quiz_' + Date.now();
            database.ref('quizzes/' + state.user.uid + '/' + quizId).set({
                title: title,
                questions: [{
                    question: '¿Pregunta de ejemplo?',
                    options: ['Opción 1', 'Opción 2', 'Opción 3', 'Opción 4'],
                    correctAnswer: 0,
                    hasCorrectAnswer: false
                }],
                createdAt: new Date().toISOString()
            });
        }

        function deleteQuiz(quizId) {
            if (!confirm('¿Borrar este quiz?')) return;
            database.ref('quizzes/' + state.user.uid + '/' + quizId).remove();
        }

        function activateQuiz(quizId) {
            const quiz = state.quizzes.find(function(q) { return q.id === quizId; });
            if (!quiz) return;
            
            state.currentQuiz = quiz;
            state.sessionId = 'session_' + Date.now();
            
            const url = window.location.origin + window.location.pathname + '?q=' + 
                        btoa(JSON.stringify({quiz: quiz, sessionId: state.sessionId}));
            
            alert('Quiz activado!\n\nComparte este link:\n' + url);
        }

        async function submitAnswers() {
            if (!state.participantName.trim()) {
                alert('Por favor ingresa tu nombre');
                return;
            }
            
            const answered = Object.keys(state.currentAnswers).length;
            if (answered < state.currentQuiz.questions.length) {
                alert('Por favor responde todas las preguntas (' + answered + '/' + state.currentQuiz.questions.length + ')');
                return;
            }
            
            try {
                await database.ref('responses/' + state.sessionId).push({
                    name: state.participantName,
                    answers: state.currentAnswers,
                    timestamp: new Date().toISOString()
                });
                
                state.view = 'thankyou';
                state.currentAnswers = {};
                state.participantName = '';
                render();
            } catch (error) {
                alert('Error al enviar: ' + error.message);
            }
        }

        auth.onAuthStateChanged(function(user) {
            if (user && state.view === 'login') {
                state.user = user;
                state.view = 'admin';
                loadQuizzes();
                render();
            }
        });

        window.addEventListener('load', function() {
            const params = new URLSearchParams(window.location.search);
            const encodedQuiz = params.get('q');
            
            if (encodedQuiz) {
                try {
                    const data = JSON.parse(atob(encodedQuiz));
                    state.currentQuiz = data.quiz;
                    state.sessionId = data.sessionId;
                    state.view = 'participant';
                } catch (e) {
                    console.error('Error:', e);
                }
            }
            
            render();
        });

    </script>
</body>
</html>
