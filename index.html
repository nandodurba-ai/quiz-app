<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Interactivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>
    <div id="app">Cargando...</div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB1-qX4gDXs-WeSBaJu6Xhrvy8fVQ7vaes",
            authDomain: "medicia-65cee.firebaseapp.com",
            databaseURL: "https://medicia-65cee-default-rtdb.firebaseio.com",
            projectId: "medicia-65cee",
            storageBucket: "medicia-65cee.firebasestorage.app",
            messagingSenderId: "640591572141",
            appId: "1:640591572141:web:19d0f3d5935c05ebbf6a24",
            measurementId: "G-M5DZ6L0WL3"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        let state = {
            view: 'login',
            user: null,
            quizzes: [],
            currentQuiz: null,
            editingQuiz: null,
            responses: {},
            participantName: '',
            currentAnswers: {},
            qrCode: '',
            sessionId: null,
            participantCount: 0
        };

        function render() {
            const app = document.getElementById('app');
            if (state.view === 'login') {
                app.innerHTML = '<div class="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 flex items-center justify-center p-4">' +
                    '<div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">' +
                    '<h1 class="text-3xl font-bold text-center mb-6">Quiz Interactivo</h1>' +
                    '<button onclick="loginWithGoogle()" class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">' +
                    'Continuar con Google' +
                    '</button>' +
                    '</div></div>';
            } else if (state.view === 'admin') {
                renderAdmin();
            } else if (state.view === 'participant') {
                renderParticipant();
            }
        }

        function renderAdmin() {
            const app = document.getElementById('app');
            let html = '<div class="min-h-screen bg-gray-50 p-6">';
            html += '<div class="max-w-4xl mx-auto">';
            html += '<div class="bg-white rounded-lg shadow p-6 mb-6">';
            html += '<div class="flex justify-between items-center">';
            html += '<h1 class="text-2xl font-bold">Mis Cuestionarios</h1>';
            html += '<button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Salir</button>';
            html += '</div></div>';
            
            html += '<div class="bg-white rounded-lg shadow p-6">';
            html += '<button onclick="newQuiz()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold mb-4">';
            html += '+ Nuevo Quiz';
            html += '</button>';
            
            if (state.quizzes.length === 0) {
                html += '<p class="text-gray-600 text-center py-8">No tienes quizzes. Crea uno nuevo.</p>';
            } else {
                html += '<div class="space-y-4">';
                state.quizzes.forEach(quiz => {
                    html += '<div class="border rounded p-4">';
                    html += '<h3 class="font-bold text-lg">' + quiz.title + '</h3>';
                    html += '<p class="text-gray-600">' + quiz.questions.length + ' preguntas</p>';
                    html += '<button onclick="activateQuiz(\'' + quiz.id + '\')" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Activar</button>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            html += '</div></div></div>';
            app.innerHTML = html;
        }

        function renderParticipant() {
            const app = document.getElementById('app');
            let html = '<div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 p-4">';
            html += '<div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-8">';
            html += '<h1 class="text-2xl font-bold mb-4">' + escapeHtml(state.currentQuiz.title) + '</h1>';
            html += '<input type="text" id="participant-name" placeholder="Tu nombre" class="w-full p-3 border-2 rounded-lg mb-6" value="' + escapeHtml(state.participantName) + '">';
            
            html += '<div class="space-y-6">';
            for (let qIndex = 0; qIndex < state.currentQuiz.questions.length; qIndex++) {
                const q = state.currentQuiz.questions[qIndex];
                html += '<div class="bg-gray-50 p-6 rounded-xl">';
                html += '<h3 class="font-bold mb-4">' + (qIndex + 1) + '. ' + escapeHtml(q.question) + '</h3>';
                html += '<div class="space-y-3">';
                
                for (let oIndex = 0; oIndex < q.options.length; oIndex++) {
                    const option = q.options[oIndex];
                    const isChecked = state.currentAnswers[qIndex] === oIndex;
                    const bgClass = isChecked ? 'bg-green-100 border-green-500' : 'bg-white border-gray-300';
                    
                    html += '<label class="flex items-center gap-3 p-3 rounded-lg cursor-pointer border-2 ' + bgClass + '">';
                    html += '<input type="radio" name="q' + qIndex + '" ';
                    if (isChecked) html += 'checked ';
                    html += 'onclick="selectAnswer(' + qIndex + ',' + oIndex + ')" class="w-5 h-5">';
                    html += '<span>' + escapeHtml(option) + '</span>';
                    html += '</label>';
                }
                
                html += '</div></div>';
            }
            html += '</div>';
            
            html += '<button onclick="submitAnswers()" class="w-full mt-6 px-6 py-4 bg-green-600 text-white rounded-xl hover:bg-green-700 font-bold text-lg">';
            html += 'Enviar Respuestas';
            html += '</button>';
            html += '</div></div>';
            
            app.innerHTML = html;
            
            const nameInput = document.getElementById('participant-name');
            if (nameInput) {
                nameInput.addEventListener('input', function(e) {
                    state.participantName = e.target.value;
                });
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
        }

        function selectAnswer(qIndex, oIndex) {
            state.currentAnswers[qIndex] = oIndex;
            render();
        }

        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                state.user = result.user;
                state.view = 'admin';
                loadQuizzes();
                render();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function logout() {
            auth.signOut();
            state.user = null;
            state.view = 'login';
            state.quizzes = [];
            render();
        }

        function loadQuizzes() {
            if (!state.user) return;
            database.ref('quizzes/' + state.user.uid).on('value', function(snapshot) {
                const data = snapshot.val();
                state.quizzes = [];
                if (data) {
                    for (let key in data) {
                        state.quizzes.push({
                            id: key,
                            title: data[key].title,
                            questions: data[key].questions || []
                        });
                    }
                }
                if (state.view === 'admin') render();
            });
        }

        function newQuiz() {
            const title = prompt('Título del quiz:');
            if (!title) return;
            
            const quizId = 'quiz_' + Date.now();
            database.ref('quizzes/' + state.user.uid + '/' + quizId).set({
                title: title,
                questions: [{
                    question: 'Pregunta de ejemplo',
                    options: ['Opción 1', 'Opción 2', 'Opción 3', 'Opción 4'],
                    correctAnswer: 0,
                    hasCorrectAnswer: false
                }],
                createdAt: new Date().toISOString()
            });
        }

        function activateQuiz(quizId) {
            const quiz = state.quizzes.find(q => q.id === quizId);
            if (!quiz) return;
            
            state.currentQuiz = quiz;
            state.sessionId = 'session_' + Date.now();
            state.qrCode = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + 
                          encodeURIComponent(window.location.origin + window.location.pathname + '?q=' + 
                          btoa(JSON.stringify({quiz: quiz, sessionId: state.sessionId})));
            
            alert('Quiz activado! Comparte el link con los participantes:\n' + 
                  window.location.origin + window.location.pathname + '?q=' + 
                  btoa(JSON.stringify({quiz: quiz, sessionId: state.sessionId})));
        }

        async function submitAnswers() {
            if (!state.participantName.trim()) {
                alert('Por favor ingresa tu nombre');
                return;
            }
            
            const answered = Object.keys(state.currentAnswers).length;
            if (answered < state.currentQuiz.questions.length) {
                alert('Por favor responde todas las preguntas');
                return;
            }
            
            try {
                await database.ref('responses/' + state.sessionId).push({
                    name: state.participantName,
                    answers: state.currentAnswers,
                    timestamp: new Date().toISOString()
                });
                alert('¡Respuestas enviadas!');
                state.currentAnswers = {};
                state.participantName = '';
            } catch (error) {
                alert('Error al enviar: ' + error.message);
            }
        }

        auth.onAuthStateChanged(function(user) {
            if (user && state.view === 'login') {
                state.user = user;
                state.view = 'admin';
                loadQuizzes();
                render();
            }
        });

        window.addEventListener('load', function() {
            const params = new URLSearchParams(window.location.search);
            const encodedQuiz = params.get('q');
            
            if (encodedQuiz) {
                try {
                    const data = JSON.parse(atob(encodedQuiz));
                    state.currentQuiz = data.quiz;
                    state.sessionId = data.sessionId;
                    state.view = 'participant';
                } catch (e) {
                    console.error('Error loading quiz:', e);
                }
            }
            
            render();
        });
    </script>
</body>
</html>
